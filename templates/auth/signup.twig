{% extends "base.twig" %}
{% block title %}Signup - Ticketrax{% endblock %}

{% block content %}
<main class="auth-page">
  <h2>Create an Account</h2>

  <form id="signupForm" novalidate>
    <label>Username
      <input type="text" id="username" name="username" />
      <span class="error" id="username-error"></span>
    </label>

    <label>Email
      <input type="email" id="email" name="email" />
      <span class="error" id="email-error"></span>
    </label>

    <label>Password
      <input type="password" id="password" name="password" />
      <span class="error" id="password-error"></span>
    </label>

    <label>Confirm Password
      <input type="password" id="confirm" name="confirm" />
      <span class="error" id="confirm-error"></span>
    </label>

    <button type="submit" class="btn-primary">Sign Up</button>
  </form>

  <p class="auth-switch">
    Already have an account?
    <a href="/auth/login" class="link">Login</a>
  </p>
</main>

<script>
function loginUser(form) {
  const { identifier, password } = form;
  const users = JSON.parse(localStorage.getItem("ticketapp_users") || "[]");
  const user = users.find(
    u => (u.username === identifier || u.email === identifier) && u.password === password
  );
  if (!user) throw new Error("Invalid credentials");
  localStorage.setItem("ticketapp_session", JSON.stringify(user));
}

function signupUser(form) {
  const users = JSON.parse(localStorage.getItem("ticketapp_users") || "[]");
  if (users.some(u => u.email === form.email))
    throw new Error("Email already exists");
  users.push(form);
  localStorage.setItem("ticketapp_users", JSON.stringify(users));
  localStorage.setItem("ticketapp_session", JSON.stringify(form));
}

function showToast(message, type = "info") {
  const container = document.getElementById("toast-container");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}


function initLoginPage() {
  document.getElementById("loginForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const form = {
      identifier: e.target.identifier.value.trim(),
      password: e.target.password.value,
    };
    try {
      loginUser(form);
      showToast("Welcome back!", "success");
      setTimeout(() => (window.location.href = "/dashboard"), 1000);
    } catch (err) {
      showToast(err.message, "error");
    }
  });
}

function initSignupPage() {
  document.getElementById("signupForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const form = {
      username: e.target.username.value.trim(),
      email: e.target.email.value.trim(),
      password: e.target.password.value,
      confirm: e.target.confirm.value,
    };
    if (form.password !== form.confirm) return showToast("Passwords do not match", "error");
    try {
      signupUser(form);
      showToast("Account created successfully!", "success");
      setTimeout(() => (window.location.href = "/dashboard"), 1000);
    } catch (err) {
      showToast(err.message, "error");
    }
  });
}
  initSignupPage();
</script>
{% endblock %}
